<?php











/**











 * Register Activation Hook











 */











update_option('refyn_search_plugin', 'woo_refyn_search');











function refyn_install()











{











    Refyn_Search::create_page('refyn-search', 'refyn_search_page_id', __('Refyn Search', 'refyn'), '[refyn_search]');











    // Set Settings Default from Admin Init











    global $refyn_search_admin_init;











    $refyn_search_admin_init->set_default_settings();











    update_option('refyn_search_lite_version', '1.0');











    flush_rewrite_rules();











	











		











	/*defaults for option tab settings*/











	$def_settings=array();











	$def_settings['refyn_no_of_character_obs_search_box_text']=3;











	$def_settings['refyn_no_of_results_search_box_text']=6;











	$def_settings['refyn_unrelated_result_search_box_text']=6;











	$def_settings['refyn_no_of_letter_search_box_text']=2;











	$def_settings['refyn_ranking_formula']=1;











	$def_settings['refyn_results_option']='no';











	$def_settings['refyn_show_images_option']='yes';











	$def_settings['refyn_predict_win_price_option']='no';











	$def_settings['refyn_search_inside_blog_option']='yes';











	$def_settings['refyn_product_sku_search_option']='no';











	$def_settings['refyn_search_inside_postcontent_option']='yes';











	$def_settings['refyn_search_inside_excerpt_option']='yes';











	$def_settings['refyn_include_outofstock_option']='no';











	$def_settings['refyn_product_categories_option']='no';











	











	/*defaults for style tab settings*/











	$def_settings['refyn_search_list_background_color']='#808080';











	$def_settings['refyn_search_list_border_color']='#cccccc';











	$def_settings['refyn_search_first_color']='#ffffff';











	$def_settings['refyn_search_second_color']='#ffffff';











	$def_settings['refyn_search_text_color']='#050b16';











	$def_settings['refyn_search_background_hover_color']='#727272';











	$def_settings['refyn_search_text_hover_color']='#ffffff';











	











	











	update_option('refyn_all_settings', $def_settings);











    update_option('refyn_search_just_installed', true);











}











function refyn_init()











{











    if (get_option('refyn_search_just_installed')) {











        delete_option('refyn_search_just_installed');











        wp_redirect(admin_url('admin.php?page=woo-refyn-search', 'relative'));











        exit;











    }











	if(!empty($_GET['s'])){











		if( ! is_admin() ) {











			$link_search = rtrim( get_permalink(get_option('refyn_search_page_id')), '/' ).'/keyword/';











			wp_redirect($link_search.sanitize_text_field( $_GET['s']) );











			exit;	











		}











	}











}











// Add language











add_action('init', 'refyn_init');











// Add custom style to dashboard











add_action('admin_enqueue_scripts', array('Refyn_Hook_Filter', 'refyn_wp_admin'));











add_action('wp_enqueue_scripts', 'wptuts_styles_with_the_lot');











add_action('plugins_loaded', array('Refyn_Hook_Filter', 'plugins_loaded'), 8);











// Add text on right of Visit the plugin on Plugin manager page











add_filter('plugin_row_meta', array('Refyn_Hook_Filter', 'plugin_extra_links'), 10, 2);











function register_widget_refyn_refyn_search()











{











    register_widget('Refyn_Search_Widgets');











}











// Need to call Admin Init to show Admin UI











global $refyn_search_admin_init;











$refyn_search_admin_init->init();











// Add upgrade notice to Dashboard pages











add_filter($refyn_search_admin_init->plugin_name . '_plugin_extension', array('Refyn_Search', 'plugin_extension'));











// Custom Rewrite Rules











add_action('init', array('Refyn_Hook_Filter', 'custom_rewrite_rule'), 101);











// Registry widget











add_action('widgets_init', 'register_widget_refyn_refyn_search');











// Add shortcode [refyn_search]











add_shortcode('refyn_search', array('Refyn_Search_Shortcodes', 'parse_shortcode_search_result'));











// Add Refyn Search Meta Box to all post type











add_action('add_meta_boxes', array('Refyn_Search_Meta', 'create_custombox'), 9);











// Save Refyn Search Meta Box to all post type











if (in_array(basename($_SERVER['PHP_SELF']), array('post.php', 'page.php', 'page-new.php', 'post-new.php'))) {











    add_action('save_post', array('Refyn_Search_Meta', 'save_custombox'));











}











// Add search widget icon to Page Editor











if (in_array(basename($_SERVER['PHP_SELF']), array('post.php', 'page.php', 'page-new.php', 'post-new.php'))) {











   // add_action('media_buttons_context', array('Refyn_Search_Shortcodes', 'add_search_widget_icon'));











    add_action('admin_footer', array('Refyn_Search_Shortcodes', 'add_search_widget_mce_popup'));











}











if (!is_admin()) {











    add_filter('posts_search', array('Refyn_Hook_Filter', 'search_by_title_only'), 500, 2);











    add_filter('posts_orderby', array('Refyn_Hook_Filter', 'refyn_posts_orderby'), 500, 2);











    add_filter('posts_request', array('Refyn_Hook_Filter', 'posts_request_unconflict_role_scoper_plugin'), 500, 2);











}











//////////////////////////////////////Add css in Wordpress Front End//////////////////////////////////////////////











function wptuts_styles_with_the_lot()











{











    // Register the style like this for a plugin:











	wp_enqueue_style( 'modied-frontend-style', REFYN_CSS_URL . '/modi_front_end_css.css' );











	wp_enqueue_style( 'clalbm-scroll-css', REFYN_CSS_URL.'/jquery.mCustomScrollbar.min.css' );











	wp_enqueue_script( 'clalbm-scroll', REFYN_JS_URL.'/jquery.mCustomScrollbar.concat.min.js'  , '', '', true );











    // For either a plugin or a theme, you can then enqueue the style:











}











// AJAX get result search page











add_action('wp_ajax_refyn_get_result_search_page', array('Refyn_Search_Shortcodes', 'get_result_search_page'));











add_action('wp_ajax_nopriv_refyn_get_result_search_page', array('Refyn_Search_Shortcodes', 'get_result_search_page'));











// AJAX get result search popup











add_action('wp_ajax_refyn_get_result_popup', array('Refyn_Hook_Filter', 'get_result_popup'));











add_action('wp_ajax_nopriv_refyn_get_result_popup', array('Refyn_Hook_Filter', 'get_result_popup'));











add_filter( 'pre_get_posts', array('Refyn_Hook_Filter', 'pre_get_posts'), 500 );











add_action('wp_head','hook_css');











if (!is_admin()) add_action('init', array('Refyn_Hook_Filter', 'add_frontend_style'));











// Check upgrade functions











add_action('plugins_loaded', 'woo_ps_lite_upgrade_plugin');











function woo_ps_lite_upgrade_plugin()











{











    // Upgrade to 1.0.9











    if (version_compare(get_option('refyn_search_lite_version'), '1.0') === -1) {











        Refyn_Search::upgrade_version_2_0();











        update_option('refyn_search_lite_version', '1.0');











    }











    update_option('refyn_search_lite_version', '1.0');











}











add_action('wp_ajax_stopword_modification_request',  'stopword_modification_request');











function stopword_modification_request(){











	global $wpdb, $setting_options;











		$remote_API_server=REMOTE_API_SERVER.'obs_v1/refyn_api.php';











		$home_url=home_url();











		$api_key=$setting_options['refyn_api_key_text'];











	











	$id = sanitize_text_field( $_POST['id'] );











	$stopword=urlencode(sanitize_text_field($_POST['stopword']));











	if(!empty($id)){











		//$result=$wpdb->update('cp_refyn_stopwords', array( 'stopword' => $stopword ), array( 'idstopwords' => $id ));











		$stopword_data = file_get_contents($remote_API_server.'?siteurl='.$home_url.'&apikey='.$api_key.'&r=editstopword&stopword='.$stopword.'&id='.$id );











  		$stopword_result = json_decode($stopword_data, true);











		











		$result=$stopword_result['result'];		











	}











	











	echo json_encode(array( 'result' => $result ));











	die();











	}











	











add_action('wp_ajax_stopword_delete_request',  'stopword_delete_request');











function stopword_delete_request(){











	global $wpdb, $setting_options;











		$remote_API_server=REMOTE_API_SERVER.'obs_v1/refyn_api.php';











		$home_url=home_url();











		$api_key=$setting_options['refyn_api_key_text'];











	











	$id = sanitize_text_field($_POST['id']);











	if(!empty($id)){











		//$result=$wpdb->delete('cp_refyn_stopwords', array( 'idstopwords' => $id ));











		$stopword_data = file_get_contents($remote_API_server.'?siteurl='.$home_url.'&apikey='.$api_key.'&r=deletestopword&id='.$id );











  		$stopword_result = json_decode($stopword_data, true);











		$result=$stopword_result['result'];	











	}











	echo json_encode(array( 'result' => $result ));











	die();











	}











add_action('wp_ajax_keyword_modification_request',  'keyword_modification_request');











function keyword_modification_request(){











	global $wpdb, $setting_options;











		$remote_API_server=REMOTE_API_SERVER.'obs_v1/refyn_api.php';











		$home_url=home_url();











		$api_key=$setting_options['refyn_api_key_text'];











	$id=urlencode(trim(sanitize_text_field($_POST['id'])));











	$seo=urlencode(trim(sanitize_text_field($_POST['seo'])));











	$times=urlencode(trim(sanitize_text_field($_POST['times'])));











	$new_the_kw_user_selected=urlencode(trim(sanitize_text_field($_POST['new_the_kw_user_selected'])));











	if(!empty($id)){











		//$result=$wpdb->update('cp_refyn_keywords', array( 'seo' => $seo, 'times' => $times, 'the_kw_user_selected' => $new_the_kw_user_selected ), array( 'kw' => $id ));











	











		$keyword_data = file_get_contents($remote_API_server.'?siteurl='.$home_url.'&apikey='.$api_key.'&r=editkeyword&key_id='.$id.'&seo='.$seo.'&times='.$times.'&new_the_kw_user_selected='.$new_the_kw_user_selected );











		











  		$keyword_result = json_decode($keyword_data, true);











		











		$result=$keyword_result['result'];











	}











	echo json_encode(array( 'result' => $result ));











	die();











	}











	











add_action('wp_ajax_keyword_delete_request',  'keyword_delete_request');











function keyword_delete_request(){











	global $wpdb, $setting_options;











		$remote_API_server=REMOTE_API_SERVER.'obs_v1/refyn_api.php';











		$home_url=home_url();











		$api_key=$setting_options['refyn_api_key_text'];











		











	$id=urlencode(trim(sanitize_text_field($_POST['id'])));











	if(!empty($id)){











		//$result=$wpdb->delete('cp_refyn_keywords', array( 'kw' => $id ));











		$stopword_data = file_get_contents($remote_API_server.'?siteurl='.$home_url.'&apikey='.$api_key.'&r=deletekeyword&id='.$id );











  		$stopword_result = json_decode($stopword_data, true);











		$result=$stopword_result['result'];	











		}











	echo json_encode(array( 'result' => $result ));











	die();











	}











	











add_action('wp_ajax_keyword_change_status',  'keyword_change_status');











function keyword_change_status(){











	global $wpdb, $setting_options;











		$remote_API_server=REMOTE_API_SERVER.'obs_v1/refyn_api.php';











		$home_url=home_url();











		$api_key=$setting_options['refyn_api_key_text'];











		











	$id =urlencode((sanitize_text_field($_POST['id'])));











	$option=urlencode(sanitize_text_field($_POST['option']));











	if(!empty($id)){











		/*if($option == 'AM')











		$result=$wpdb->update('cp_refyn_keywords', array( 'source' => $option), array( 'kw' => $id ));











		else if($option == 'DS')











		$result=$wpdb->delete( 'cp_refyn_keywords', array( 'kw' => $id ) );*/











		$stopword_data = file_get_contents($remote_API_server.'?siteurl='.$home_url.'&apikey='.$api_key.'&r=change_keyword_status&id='.$id.'&option='.$option );











  		$stopword_result = json_decode($stopword_data, true);











		$result=$stopword_result['result'];











		











	}











	echo json_encode(array( 'result' => $result ));











	die();











}











	











 function hook_css(){











	global $setting_options;











	if(!empty($setting_options['refyn_search_list_background_color']))











	$bgcolor=$setting_options['refyn_search_list_background_color'];











	else











	$bgcolor="#808080";











	if(!empty($setting_options['refyn_search_first_color']))











	$first_row_color=$setting_options['refyn_search_first_color'];











	else











	$first_row_color='#ffffff';











	











	if(!empty($setting_options['refyn_search_second_color']))











	$sec_row_color=$setting_options['refyn_search_second_color'];











	else











	$sec_row_color='#ffffff';











	











	if(!empty($setting_options['refyn_search_background_hover_color']))











	$bac_hover=$setting_options['refyn_search_background_hover_color'];











	else











	$bac_hover='#727272';











	











	if(!empty($setting_options['refyn_search_searchbox_popup_width']))











	$popup_width=$setting_options['refyn_search_searchbox_popup_width'];











	else











	$popup_width='320';











	











	if($setting_options['refyn_front_dropdown_option']=='no' || empty($setting_options['refyn_front_dropdown_option']))











	{











		//$dropdown='width:'. absint($popup_width) .'px !important;';





$dropdown='';





		$p_list='width:75% !important;';











		$p_list_txt='width:75% !important;';











		$p_av='width:50px !important;';











	}











		$output="<style> .refyn_results{background-color: ".$bgcolor.";border: 1px solid ".$setting_options['refyn_search_list_border_color'].";".$dropdown."}











		











		.refyn_results ul li .rs_content_popup .rs_product_dt{".$p_list_txt."}











		.refyn_results ul li .rs_avatar{".$p_av."}











		.ac_even {background-color : ".$first_row_color.";}











		.ac_odd {background-color : ".$sec_row_color.";}











		.ac_over > .ajax_search_content { background-color : ".$bac_hover.";}











		.rs_name{font-weight:bold;}











		.rs_name, .rs_description{color: ".$setting_options['refyn_search_text_color']."; }











		.refyn_results ul li.ac_over a, .refyn_results ul li.ac_over a .rs_name, .refyn_results ul li.ac_over a .rs_description{color: ".$setting_options['refyn_search_text_hover_color']."; }";











		











		if( get_option('refyn_search_page_id') ) {











			$menu_items = get_posts(array(











				'posts_per_page'	=> -1,











				'post_type'			=> 'nav_menu_item',











				'meta_query'		=> array(











					array(











						'key'     => '_menu_item_object_id',











						'value'   => get_option('refyn_search_page_id'),











						'compare' => '='











					)











				)











			));











			if( $menu_items ) {











				foreach( $menu_items as $item ) {











					$output .= ".menu-item-". $item->ID ." {display: none !important; }";











				}











			}











		}











			











$avatar_enable=$setting_options['refyn_show_images_option'];











	if(!empty($avatar_enable) && $avatar_enable == 'no'){











		











			$output .=	" .rs_content_popup{width:100% !important;}";











			











	}











	











	$output .= "</style>";











	echo $output;











		











		}